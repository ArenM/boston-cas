#!/usr/bin/env ruby
require 'pathname'
require 'fileutils'

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../',  __FILE__)

Dir.chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:

  puts "== Installing dependencies =="
  system "gem install bundler --conservative"
  system "bundle check || bundle install"

  puts "\n== Updating CAS database =="
  system "bin/rake db:migrate"

  puts "\n== Updating Available Rules =="
  system "bin/rake cas_seeds:create_rules"
  puts "\n== Updating Available Services =="
  system "bin/rake cas_seeds:create_services"
  puts "\n== Updating any broken user accounts, adding contacts =="
  system "bin/rake cas_seeds:ensure_all_users_have_contacts"
  puts "\n== Updating Available Decision Reasons =="
  system "bin/rake cas_seeds:create_match_decision_reasons"
  puts "\n== Updating Routes =="
  system "bin/rake cas_seeds:ensure_all_match_routes_exist"
  puts "\n== Updating Prioritization schemes =="
  system "bin/rake cas_seeds:ensure_all_match_prioritization_schemes_exist"

  puts "\n== Removing old logs and tempfiles =="
  FileUtils.rm_f Dir.glob(File.join('log', '*'))
  FileUtils.rm_rf Dir.glob(File.join('tmp', 'cache'))

  puts "\n== Restarting application server =="
  unless File.exist? 'tmp'
    FileUtils.mkdir 'tmp'
  end
  restart = File.join %w(tmp restart.txt)
  FileUtils.touch restart
  system 'puma-dev -stop'
end
